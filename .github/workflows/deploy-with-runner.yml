name: Deploy with Self-Hosted Runner

on:
  push:
    branches:
      - main  # Change this to your default branch if different
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: self-hosted  # This tells GitHub to use your self-hosted runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          path: repo  # Checkout code to a subdirectory
      
      - name: Setup deployment
        run: |
          # Copy files to deployment directory
          cp -r ./repo/* ${{ secrets.DEPLOY_PATH }}/
          cp ./repo/.env ${{ secrets.DEPLOY_PATH }}/ 2>/dev/null || true
          cp ./repo/.dockerignore ${{ secrets.DEPLOY_PATH }}/ 2>/dev/null || true
          
          # Set correct permissions if needed
          chown -R root:root ${{ secrets.DEPLOY_PATH }}
          
          # Create .env file from secrets
          cat << EOF > ${{ secrets.DEPLOY_PATH }}/.env
          # Generated by GitHub Actions Runner
          NGINX_SERVER_NAME=${{ secrets.NGINX_SERVER_NAME }}
          FRONTEND_PUBLIC_PORT=${{ secrets.FRONTEND_PUBLIC_PORT }}
          LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
          API_BASE_URL=${{ secrets.API_BASE_URL }}
          EOF
          
          # Navigate to deployment directory and restart Docker
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Rebuild and restart containers
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          # Show logs to confirm deployment
          docker compose logs -f --tail=20 frontend 